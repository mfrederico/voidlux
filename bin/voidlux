#!/usr/bin/env php
<?php
/**
 * VoidLux CLI
 *
 * Commands:
 *   demo          -- Run the graffiti wall demo
 *   coop          -- Run the smart chicken coop server
 *   swarm         -- Run the swarm orchestration server
 *   seneschal     -- Run the stable reverse proxy for swarm dashboard
 *   compile <dir> -- Compile a PHP app into a static binary
 *   detect <dir>  -- Detect required extensions
 */

declare(strict_types=1);

// Find and load autoloader
$autoloadPaths = [
    __DIR__ . '/../vendor/autoload.php',
    __DIR__ . '/../../../autoload.php',
];

$autoloaded = false;
foreach ($autoloadPaths as $path) {
    if (file_exists($path)) {
        require $path;
        $autoloaded = true;
        break;
    }
}

if (!$autoloaded) {
    // Fallback: simple PSR-4 autoloader for development
    spl_autoload_register(function (string $class): void {
        $prefix = 'VoidLux\\';
        if (!str_starts_with($class, $prefix)) {
            return;
        }
        $relative = substr($class, strlen($prefix));
        $file = __DIR__ . '/../src/' . str_replace('\\', '/', $relative) . '.php';
        if (file_exists($file)) {
            require $file;
        }
    });
}

use VoidLux\Compat\OpenSwooleShim;

// Register OpenSwoole compatibility
if (class_exists('Swoole\\Http\\Server', false)) {
    OpenSwooleShim::register();
}

// Parse CLI arguments
$args = $argv;
array_shift($args); // Remove script name

$command = array_shift($args) ?? 'help';

// Parse --key=value options
$options = [];
$positional = [];
foreach ($args as $arg) {
    if (str_starts_with($arg, '--')) {
        $parts = explode('=', substr($arg, 2), 2);
        $key = $parts[0];
        $value = $parts[1] ?? true;
        $options[$key] = $value;
    } else {
        $positional[] = $arg;
    }
}

switch ($command) {
    case 'demo':
        runDemo($options);
        break;

    case 'coop':
        runCoop($options);
        break;

    case 'swarm':
        runSwarm($options);
        break;

    case 'seneschal':
        runSeneschal($options);
        break;

    case 'compile':
        runCompile($positional, $options);
        break;

    case 'detect':
        runDetect($positional);
        break;

    case 'help':
    case '--help':
    case '-h':
        showHelp();
        break;

    default:
        echo "Unknown command: {$command}\n\n";
        showHelp();
        exit(1);
}

function runDemo(array $options): void
{
    $httpPort = (int) ($options['http-port'] ?? 8080);
    $p2pPort = (int) ($options['p2p-port'] ?? 7001);
    $discoveryPort = (int) ($options['discovery-port'] ?? 6001);
    $seeds = isset($options['seeds']) ? explode(',', $options['seeds']) : [];
    $dataDir = $options['data-dir'] ?? './data';

    $server = new \VoidLux\App\GraffitiWall\Server(
        httpHost: '0.0.0.0',
        httpPort: $httpPort,
        p2pPort: $p2pPort,
        discoveryPort: $discoveryPort,
        seedPeers: $seeds,
        dataDir: $dataDir,
    );

    $server->run();
}

function runCoop(array $options): void
{
    $httpPort = (int) ($options['http-port'] ?? 8080);
    $p2pPort = (int) ($options['p2p-port'] ?? 7001);
    $discoveryPort = (int) ($options['discovery-port'] ?? 6001);
    $seeds = isset($options['seeds']) ? explode(',', $options['seeds']) : [];
    $dataDir = $options['data-dir'] ?? './data';
    $coopName = $options['name'] ?? 'Coop-1';

    $server = new \VoidLux\App\SmartCoop\Server(
        httpHost: '0.0.0.0',
        httpPort: $httpPort,
        p2pPort: $p2pPort,
        discoveryPort: $discoveryPort,
        seedPeers: $seeds,
        dataDir: $dataDir,
        coopName: $coopName,
    );

    $server->run();
}

function runSwarm(array $options): void
{
    $httpPort = (int) ($options['http-port'] ?? 9090);
    $p2pPort = (int) ($options['p2p-port'] ?? 7101);
    $discoveryPort = (int) ($options['discovery-port'] ?? 6101);
    $seeds = isset($options['seeds']) ? explode(',', $options['seeds']) : [];
    $dataDir = $options['data-dir'] ?? './data';
    $role = $options['role'] ?? 'emperor';
    $llmProvider = $options['llm-provider'] ?? 'ollama';
    $llmModel = $options['llm-model'] ?? 'qwen3:32b';
    $llmHost = $options['llm-host'] ?? '127.0.0.1';
    $llmPort = (int) ($options['llm-port'] ?? 11434);
    $claudeApiKey = $options['claude-api-key'] ?? '';
    $testCommand = $options['test-command'] ?? '';
    $authSecret = $options['auth-secret'] ?? getenv('VOIDLUX_AUTH_SECRET') ?: '';

    $server = new \VoidLux\Swarm\Server(
        httpHost: '0.0.0.0',
        httpPort: $httpPort,
        p2pPort: $p2pPort,
        discoveryPort: $discoveryPort,
        seedPeers: $seeds,
        dataDir: $dataDir,
        role: $role,
        llmProvider: $llmProvider,
        llmModel: $llmModel,
        llmHost: $llmHost,
        llmPort: $llmPort,
        claudeApiKey: $claudeApiKey,
        testCommand: $testCommand,
        authSecret: $authSecret,
    );

    $server->run();
}

function runSeneschal(array $options): void
{
    $httpPort = (int) ($options['http-port'] ?? 9090);
    $p2pPort = (int) ($options['p2p-port'] ?? 7100);
    $discoveryPort = (int) ($options['discovery-port'] ?? 6101);
    $seeds = isset($options['seeds']) ? explode(',', $options['seeds']) : [];
    $dataDir = $options['data-dir'] ?? './data';

    $server = new \VoidLux\Swarm\Seneschal(
        httpHost: '0.0.0.0',
        httpPort: $httpPort,
        p2pPort: $p2pPort,
        discoveryPort: $discoveryPort,
        seedPeers: $seeds,
        dataDir: $dataDir,
    );
    $server->run();
}

function runCompile(array $positional, array $options): void
{
    $appDir = $positional[0] ?? '.';
    $output = $options['output'] ?? '';
    $entryPoint = $options['entry-point'] ?? '';
    $appName = $options['app-name'] ?? '';

    $compiler = new \VoidLux\Compiler\Compiler();
    $success = $compiler->compile($appDir, $output, $entryPoint, $appName);

    exit($success ? 0 : 1);
}

function runDetect(array $positional): void
{
    $appDir = $positional[0] ?? '.';

    $compiler = new \VoidLux\Compiler\Compiler();
    $extensions = $compiler->detect($appDir);

    echo "Detected extensions in: {$appDir}\n";
    foreach ($extensions as $ext) {
        echo "  - {$ext}\n";
    }
    echo "\nTotal: " . count($extensions) . " extensions\n";
}

function showHelp(): void
{
    echo <<<HELP
VoidLux - P2P OpenSwoole Compiler & Swarm Orchestration

Usage:
  voidlux <command> [options]

Commands:
  demo                    Run the graffiti wall P2P demo
  coop                    Run the smart chicken coop server
  swarm                   Run the swarm orchestration server
  seneschal               Stable reverse proxy for swarm dashboard
  compile <app-dir>       Compile a PHP app into a static binary
  detect <app-dir>        Detect required PHP extensions

Demo Options:
  --http-port=PORT        HTTP server port (default: 8080)
  --p2p-port=PORT         P2P TCP mesh port (default: 7001)
  --discovery-port=PORT   UDP discovery port (default: 6001)
  --seeds=HOST:PORT,...   Comma-separated seed peers
  --data-dir=DIR          Data directory (default: ./data)

Coop Options:
  --http-port=PORT        HTTP server port (default: 8080)
  --p2p-port=PORT         P2P TCP mesh port (default: 7001)
  --discovery-port=PORT   UDP discovery port (default: 6001)
  --seeds=HOST:PORT,...   Comma-separated seed peers
  --data-dir=DIR          Data directory (default: ./data)
  --name=NAME             Coop name (default: Coop-1)

Swarm Options:
  --http-port=PORT        HTTP/WS port (default: 9090)
  --p2p-port=PORT         P2P TCP mesh port (default: 7101)
  --discovery-port=PORT   UDP discovery port (default: 6101)
  --seeds=HOST:PORT,...   Comma-separated seed peers
  --data-dir=DIR          Data directory (default: ./data)
  --role=ROLE             Role: emperor or worker (default: emperor)
  --llm-provider=NAME     LLM provider: ollama or claude (default: ollama)
  --llm-model=MODEL       LLM model name (default: qwen3:32b)
  --llm-host=HOST         Ollama host (default: 127.0.0.1)
  --llm-port=PORT         Ollama port (default: 11434)
  --claude-api-key=KEY    Claude API key (for claude provider)
  --test-command=CMD      Test command to run after merging subtask branches
  --auth-secret=SECRET    Shared secret for P2P auth (or VOIDLUX_AUTH_SECRET env)

Seneschal Options:
  --http-port=PORT        Proxy listen port (default: 9090)
  --p2p-port=PORT         P2P TCP mesh port (default: 7100)
  --discovery-port=PORT   UDP discovery port (default: 6101)
  --seeds=HOST:PORT,...   Comma-separated seed peers
  --data-dir=DIR          Data directory for upgrade history (default: ./data)

Compile Options:
  --output=PATH           Output binary path
  --entry-point=FILE      PHP entry point file
  --app-name=NAME         Application name

HELP;
}
